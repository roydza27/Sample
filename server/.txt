import db_metrics from './db.js'
//Metric data to be Exported to a database
const metrics = [];

// Global middleware
app.use((req, res, next) => {
  const start = Date.now();
  res.on("finish", () => {
    const responseTime = Date.now() - start;
    const isError = res.statusCode >= 400;

    metrics.push({
      route: req.path,
      method: req.method,
      status: res.statusCode,
      responseTime,
      isError
    });

    try {
      db_metrics.prepare(`
        INSERT INTO api_metrics (route, method, status, response_time, is_error)
        VALUES (?, ?, ?, ?, ?)
      `).run(
        req.path,
        req.method,
        res.statusCode,
        responseTime,
        isError ? 1 : 0
      );
    } catch {}
  });
  next();
});

// Metrics endpoints
app.get("/api/metrics/summary", (req, res) => {
  const total = metrics.length;
  const errors = metrics.filter(m => m.isError).length;
  const avg = metrics.reduce((s, m) => s + m.responseTime, 0) / (total || 1);
  res.json({ totalRequests: total, avgResponseTime: avg, errorRate: total ? (errors/total)*100 : 0 });
});

app.get("/api/metrics/routes", (req, res) => res.json(metrics));
app.get("/api/metrics/export", (req, res) => res.json(metrics));
